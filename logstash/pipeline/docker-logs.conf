# ============================================
# Logstash Pipeline 配置
# 1) 接收 Filebeat 日志
# 2) 区分 应用 JSON / Gunicorn / 其他
# 3) 解析字段 + 异常堆栈
# 4) ECS 映射 + severity/索引路由
# ============================================

input { beats { port => 5044 type => "beats" } }

filter {
  # 1) 日志类型识别
  if [log_type] == "application"     { mutate { add_field => { "[@metadata][log_format]" => "json_app" } } }
  else if [log_type] == "gunicorn_access" { mutate { add_field => { "[@metadata][log_format]" => "gunicorn" } } }
  else                                { mutate { add_field => { "[@metadata][log_format]" => "other" } } }

  # 2) 应用日志（异常堆栈 + ECS）
  if [@metadata][log_format] == "json_app" {
    if [exception][stacktrace] {
      
      # 将堆栈跟踪数组合并为单个字符串
      ruby {
        code => '
          stacktrace = event.get("[exception][stacktrace]")
          if stacktrace.is_a?(Array)
            # 合并所有堆栈行
            full_stacktrace = stacktrace.join("")
            event.set("[exception][full_stacktrace]", full_stacktrace)
            
            # 提取异常关键信息
            event.set("[exception][has_stacktrace]", true)
            
            # 统计堆栈深度
            event.set("[exception][stack_depth]", stacktrace.length)
          end
        '
      }
      
      grok {
        match => {
          "[exception][full_stacktrace]" => [
            'File "%{DATA:exception_file}", line %{NUMBER:exception_line}',
            'at %{DATA:exception_class}\.%{DATA:exception_method}\(%{DATA:exception_file}:%{NUMBER:exception_line}\)'
          ]
        }
        tag_on_failure => []
        overwrite => ["exception_file", "exception_line"]
      }
      
      mutate {
        add_tag => ["has_exception", "multiline_log"]
        add_field => { "severity" => "ERROR" }
      }
    }
    
    mutate { rename => { "level" => "log_level" } }
    if [log_level] and [log_level] !~ "^(DEBUG|INFO|WARN|WARNING|ERROR|FATAL|CRITICAL)$" { mutate { replace => { "log_level" => "INFO" } } }
    if [log_level] in ["ERROR", "FATAL", "CRITICAL"] { mutate { add_tag => ["error_log"]   add_field => { "severity" => "ERROR" } } }
    else if [log_level] in ["WARN", "WARNING"]        { mutate { add_tag => ["warning_log"] add_field => { "severity" => "WARNING" } } }
    else                                              { mutate { add_tag => ["info_log"]    add_field => { "severity" => "INFO" } } }
    
    # HTTP 相关信息
    if [http_method] {
      if [url] {
        grok {
          match => {
            "url" => "https?://[^/]+(?<url_path>/[^\?]*)(\?%{GREEDYDATA:url_params})?"
          }
          tag_on_failure => []
        }
      }
      
      mutate { convert => { "status_code" => "integer" "response_time_ms" => "float" } }
      if [status_code] >= 500 { mutate { add_tag => ["http_5xx", "server_error"] add_field => { "http_status_category" => "5xx Server Error" } } }
      else if [status_code] >= 400 { mutate { add_tag => ["http_4xx", "client_error"] add_field => { "http_status_category" => "4xx Client Error" } } }
      else if [status_code] >= 300 { mutate { add_tag => ["http_3xx", "redirect"] add_field => { "http_status_category" => "3xx Redirect" } } }
      else if [status_code] >= 200 { mutate { add_tag => ["http_2xx", "success"] add_field => { "http_status_category" => "2xx Success" } } }
      if [response_time_ms] >= 1000 { mutate { add_tag => ["slow_request"] } }
      if [response_time_ms] >= 3000 { mutate { add_tag => ["very_slow_request"] } }
      
      # 响应时间分级
      if [response_time_ms] {
        ruby {
          code => '
            rt = event.get("response_time_ms").to_f
            if rt < 100
              event.set("response_time_category", "fast")
            elsif rt < 500
              event.set("response_time_category", "normal")
            elsif rt < 1000
              event.set("response_time_category", "slow")
            else
              event.set("response_time_category", "very_slow")
            end
          '
        }
      }
    
    # 基于状态码的 severity 兜底（避免缺失 log_level 时全部为 INFO）
    if ![severity] or [severity] == "INFO" {
      if [status_code] >= 500 {
        mutate {
          add_field => { "severity" => "ERROR" "log_level" => "ERROR" }
          add_tag => ["severity_override_5xx"]
        }
      } else if [status_code] >= 400 {
        mutate {
          add_field => { "severity" => "WARNING" "log_level" => "WARNING" }
          add_tag => ["severity_override_4xx"]
        }
      }
    }
    }
    
    # User-Agent 解析（增强分析）
    if [user_agent] {
      useragent {
        source => "user_agent"
        target => "user_agent_parsed"
        add_field => { "user_agent_original" => "%{user_agent}" }
      }
      
      # 提取浏览器和设备信息
      if [user_agent_parsed][name] {
        mutate {
          add_field => { "browser" => "%{[user_agent_parsed][name]}" }
          add_field => { "browser_version" => "%{[user_agent_parsed][major]}" }
        }
      }
      if [user_agent_parsed][os_name] {
        mutate {
          add_field => { "os" => "%{[user_agent_parsed][os_name]}" }
          add_field => { "os_version" => "%{[user_agent_parsed][os_major]}" }
        }
      }
      if [user_agent_parsed][device] {
        mutate {
          add_field => { "device_type" => "%{[user_agent_parsed][device]}" }
        }
      }
    }
    
    # IP 地理位置分析（使用 GeoIP，需要安装 geoip 插件）
    # 注意：实际使用时需要下载 GeoIP 数据库文件
    # if [ip] {
    #   geoip {
    #     source => "ip"
    #     target => "geoip"
    #   }
    # }
    
    # 时间戳
    if [timestamp] {
      date {
        match => [ 
          "timestamp", 
          "ISO8601",
          "yyyy-MM-dd'T'HH:mm:ss.SSSSSSSSS'Z'",
          "yyyy-MM-dd'T'HH:mm:ss.SSSSSS'Z'",
          "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",
          "yyyy-MM-dd'T'HH:mm:ss'Z'"
        ]
        target => "@timestamp"
        tag_on_failure => ["_dateparsefailure"]
      }
    }

    # ECS 映射
    mutate { add_field => { "[event][dataset]" => "webapp.application" } }
    if [service_name]          { mutate { add_field => { "[service][name]" => "%{service_name}" } } }
    else if [container][name]  { mutate { add_field => { "[service][name]" => "%{[container][name]}" } } }
    if [log_level]             { mutate { add_field => { "[log][level]" => "%{log_level}" } } }
    if [trace_id]              { mutate { add_field => { "[trace][id]" => "%{trace_id}" } } }
    if [http_method]           { mutate { add_field => { "[http][request][method]" => "%{http_method}" } } }
    if [url]                   { mutate { add_field => { "url_original" => "%{url}" } } }
    if [url_path]              { mutate { add_field => { "url_path_value" => "%{url_path}" } } }
    if [status_code]           { mutate { add_field => { "[http][response][status_code]" => "%{status_code}" } } }
    if [ip]                    { mutate { add_field => { "[client][ip]" => "%{ip}" } } }
    if [user_agent]            { mutate { add_field => { "user_agent_original" => "%{user_agent}" } } }
    if [response_time_ms]      { ruby { code => 'rt=event.get("response_time_ms"); event.set("[event][duration]", (rt.to_f*1_000_000).to_i) if rt' } }
    if [exception][message]    { mutate { add_field => { "[error][message]" => "%{[exception][message]}" } } }
    if [exception][type]       { mutate { add_field => { "[error][type]" => "%{[exception][type]}" } } }
    if [exception][full_stacktrace] { mutate { add_field => { "[error][stack_trace]" => "%{[exception][full_stacktrace]}" } } }
  }

  # ============================================
  # 3. Gunicorn 访问日志处理
  # ============================================
  
  if [@metadata][log_format] == "gunicorn" {
    
    # Gunicorn 访问日志格式:
    # 127.0.0.1 - - [06/Dec/2025:10:30:45 +0000] "GET /api/user/1 HTTP/1.1" 200 150
    
    # 使用 Grok 解析访问日志
    grok {
      match => {
        "message" => '%{IPORHOST:client_ip} - - \[%{HTTPDATE:access_timestamp}\] "%{WORD:http_method} %{URIPATHPARAM:url_path} HTTP/%{NUMBER:http_version}" %{NUMBER:status_code} %{NUMBER:response_bytes}'
      }
      tag_on_failure => ["_grokparsefailure_gunicorn"]
    }
    
    # 如果 Grok 成功
    if "_grokparsefailure_gunicorn" not in [tags] {
      
      # 解析时间戳
      date {
        match => [ "access_timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
        target => "@timestamp"
        tag_on_failure => ["_dateparsefailure_gunicorn"]
      }
      
      # 转换数字字段
      mutate {
        convert => {
          "status_code" => "integer"
          "response_bytes" => "integer"
        }
      }
      
      # HTTP 状态码分类
      if [status_code] >= 500 {
        mutate {
          add_tag => ["http_5xx", "server_error"]
          add_field => { 
            "severity" => "ERROR"
            "log_level" => "ERROR"
          }
        }
      } else if [status_code] >= 400 {
        mutate {
          add_tag => ["http_4xx", "client_error"]
          add_field => { 
            "severity" => "WARNING"
            "log_level" => "WARNING"
          }
        }
      } else {
        mutate {
          add_tag => ["http_success"]
          add_field => { 
            "severity" => "INFO"
            "log_level" => "INFO"
          }
        }
      }
      
      # 提取 URL 组件
      grok {
        match => {
          "url_path" => "^(?<url_base>/[^/]+)(/(?<url_resource>.*))?$"
        }
        tag_on_failure => []
      }
    }
  }

  # ============================================
  # 4. 通用字段处理
  # ============================================
  
  # 添加容器信息标签
  if [container][name] {
    mutate {
      add_field => { "service_name" => "%{[container][name]}" }
    }
  }
  
  # 添加处理时间戳
  ruby {
    code => "event.set('processed_at', Time.now.utc.iso8601)"
  }
  
  # 创建小写的 severity 字段(用于 Elasticsearch 索引名称)
  if [severity] {
    mutate {
      copy => { "severity" => "severity_lowercase" }
      lowercase => ["severity", "severity_lowercase"]
    }
  }
  else if [log_level] {
    mutate {
      copy => { "log_level" => "severity_lowercase" }
      lowercase => ["severity_lowercase"]
      add_field => { "severity" => "%{severity_lowercase}" }
    }
  }
  else if [status_code] {
    mutate { convert => { "status_code" => "integer" } }
    if [status_code] >= 500 {
      mutate { add_field => { "severity" => "ERROR" "log_level" => "ERROR" } }
    } else if [status_code] >= 400 {
      mutate { add_field => { "severity" => "WARNING" "log_level" => "WARNING" } }
    } else {
      mutate { add_field => { "severity" => "INFO" "log_level" => "INFO" } }
    }
    mutate {
      copy => { "severity" => "severity_lowercase" }
      lowercase => ["severity_lowercase"]
    }
  }

  # 设备类型字段规范化（将 JSON/对象/数组 统一为纯字符串）
  if [device_type] {
    ruby {
      code => '
        dt = event.get("device_type")
        if dt.is_a?(Hash)
          event.set("device_type", dt["name"] || dt.values.first)
        elsif dt.is_a?(Array)
          dt.each do |v|
            if v.is_a?(Hash)
              event.set("device_type", v["name"] || v.values.first)
              break
            elsif v
              event.set("device_type", v)
              break
            end
          end
        elsif dt.is_a?(String)
          m = dt.match(/"name"\s*:\s*"([^"]+)"/)
          event.set("device_type", m[1]) if m
        end
      '
    }
  }
  
  # 移除冗余字段
  mutate {
    remove_field => [
      "@version",
      "log_type",
      "access_timestamp"
    ]
  }
}


output {
  # ============================================
  # 输出到 Elasticsearch - 按日志类型和级别分索引
  # ============================================
  
  # 应用日志(JSON 格式)
  if [@metadata][log_format] == "json_app" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      # 根据日志级别分索引(转换为小写)
      index => "webapp-logs-%{[severity_lowercase]}-%{+YYYY.MM.dd}"
      document_id => "%{[@metadata][fingerprint]}"
    }
  }
  
  # Gunicorn 访问日志
  else if [@metadata][log_format] == "gunicorn" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "webapp-access-%{+YYYY.MM.dd}"
      document_id => "%{[@metadata][fingerprint]}"
    }
  }
  
  # 其他日志
  else {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "webapp-other-%{+YYYY.MM.dd}"
      document_id => "%{[@metadata][fingerprint]}"
    }
  }
}
